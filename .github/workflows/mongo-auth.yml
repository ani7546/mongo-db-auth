name: MongoDB Atlas Query Workflow

on:
  push:
    branches:
      - main

jobs:
  execute-query:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # Step 2: Get current IP address
      - name: Get current IP
        id: ip
        uses: haythem/public-ip@v1.3
      
      # Step 3: Authenticate with MongoDB Atlas
      - name: Authenticate with MongoDB Atlas
        uses: mongodb/atlas-github-action@v0.2.0
        with:
          publicApiKey: ${{ secrets.PUBLIC_API_KEY }}
          privateApiKey: ${{ secrets.PRIVATE_API_KEY }}
          projectId: ${{ secrets.PROJECT_ID }}
      
      # Step 4: Add current IP to Atlas access list
      - name: Add IP to Atlas access list
        run: |
          curl --request POST \
            --url "https://cloud.mongodb.com/api/atlas/v1.0/groups/${{ secrets.PROJECT_ID }}/accessList" \
            --header "Content-Type: application/json" \
            --header "Accept: application/json" \
            --header "Authorization: ApiKey ${{ secrets.PUBLIC_API_KEY }}:${{ secrets.PRIVATE_API_KEY }}" \
            --data '{"ipAddress":"${{ steps.ip.outputs.ipv4 }}/32","comment":"GitHub Actions temporary access"}'
      
      # Step 5: Setup MongoDB Tools
      - name: Setup MongoDB Tools
        uses: boly38/action-mongo-tools@stable
        with:
          mongo-shell: "true"
          mongo-tools: "false"
      
      # Step 6: Execute query from file
      - name: Execute Query from File
        run: |
          mongosh "${{ secrets.MONGO_URI }}" query.js
      
      # Step 7: Remove IP from Atlas access list
      - name: Remove IP from Atlas access list
        if: always()
        run: |
          curl --request DELETE \
            --url "https://cloud.mongodb.com/api/atlas/v1.0/groups/${{ secrets.PROJECT_ID }}/accessList/${{ steps.ip.outputs.ipv4 }}" \
            --header "Accept: application/json" \
            --header "Authorization: ApiKey ${{ secrets.PUBLIC_API_KEY }}:${{ secrets.PRIVATE_API_KEY }}"
